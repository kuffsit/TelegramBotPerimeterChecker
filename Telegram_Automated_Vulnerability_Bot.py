import os
import requests
import subprocess
import json
import time
import tempfile

# Your Tokens and Chat ID
telegram_token = 'your_telegram_token'
securitytrails_token = 'your_securitytrails_token'
chat_id = 'your_chat_id'  # Your Group ID

# Domains to check
domains = ['example.com1', 'example.com2', 'example.com3', 'example.com4', 'example.com5']

# Function to send messages to Telegram
def send_telegram_message(message):
    url = f'https://api.telegram.org/bot{telegram_token}/sendMessage'
    payload = {
        'chat_id': chat_id,
        'text': message,
        'parse_mode': 'HTML'
    }
    requests.post(url, data=payload)

# Function to get subdomains from SecurityTrails
def get_subdomains(domain):
    url = f'https://api.securitytrails.com/v1/domain/{domain}/subdomains'
    headers = {
        'APIKEY': securitytrails_token
    }
    response = requests.get(url, headers=headers)
    subdomains = []
    if response.status_code == 200:
        data = response.json()
        subdomains = [f"{sub}.{domain}" for sub in data.get('subdomains', [])]
    return subdomains

# Function to scan subdomains using Nmap
def scan_ports(subdomain):
    command = f"nmap -p 22,23,25,53,80,110,143,443,445,993,995,1433,3306,3389,5900,8080,8443 {subdomain} --open --no-styles"
    result = subprocess.run(command.split(), capture_output=True, text=True)
    return result.stdout

# Function to check vulnerabilities using Nuclei
def scan_vulnerabilities(subdomain):
    command = f"nuclei -u {subdomain} -silent -no-color -severity medium,high,critical"
    result = subprocess.run(command.split(), capture_output=True, text=True)
    return result.stdout

# Main function to generate the report
def generate_report(domain):
    report = f"Security Scan Report for {domain}\n\n"
    summary = f"Report for domain {domain}\n\nActive subdomains:\n"
    
    subdomains = get_subdomains(domain)
    if not subdomains:
        report += "No subdomains found.\n"
        summary += "No active subdomains found.\n"
    else:
        for subdomain in subdomains:
            report += f"- {subdomain}\n"
            port_scan_result = scan_ports(subdomain)
            vuln_scan_result = scan_vulnerabilities(subdomain)

            vuln_count = vuln_scan_result.count('\n') if vuln_scan_result else 0
            open_ports = ', '.join([line.split()[0] for line in port_scan_result.splitlines() if '/tcp' in line])

            summary += f"- {subdomain} â€” {vuln_count} vulnerabilities, ports {open_ports} are open\n"

            report += "\nNmap Scan Results:\n"
            report += port_scan_result
            
            if vuln_scan_result:
                report += "\nNuclei Scan Results:\n"
                report += vuln_scan_result
            
            report += "\n" + "-"*30 + "\n"
    
    summary += f"\nReport generated: {time.strftime('%Y-%m-%d %H:%M:%S')}\n"
    
    # Creating a temporary file
    with tempfile.NamedTemporaryFile(delete=False, mode='w', suffix='.txt') as temp_file:
        temp_file.write(report)
        temp_file_path = temp_file.name
    
    # Sending the report file to Telegram
    send_telegram_message(summary)
    send_file_to_telegram(temp_file_path)
    
    # Deleting the temporary file
    os.remove(temp_file_path)

# Function to send the report file to Telegram
def send_file_to_telegram(file_path):
    url = f'https://api.telegram.org/bot{telegram_token}/sendDocument'
    with open(file_path, 'rb') as file:
        files = {'document': file}
        data = {'chat_id': chat_id}
        requests.post(url, files=files, data=data)

# Running the check and generating the report for each domain
for domain in domains:
    generate_report(domain)
